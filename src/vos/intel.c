//
// Created by x7cc on 2020/4/14.
//

#include "vos/debug.h"
#include "vos/ept.h"
#include "vos/guest.h"
#include "vos/intel.h"
#include "vos/memory.h"
#include "vos/stdio.h"
#include "vos/vmx.h"
#include "vos/vos.h"
#include "vos/x86.h"
#include "vos/x86_64.h"

int check_vmx ()
{
  cpuid_t cpuid;
  __cpuid (&cpuid, 1);
  if ((cpuid.ecx & (1 << 5)) == 0)
  {
    puts ("not support vmx");
    return -1;
  }

  vos_uint64 msr = __read_msr (IA32_FEATURE_CONTROL);
  if ((msr & IA32_FEATURE_CONTROL_VMXON_MASK) == 0)
  {
    puts ("vmxon");
    return -1;
  }

  if ((msr & IA32_FEATURE_CONTROL_LOCK_MASK) == 0)
  {
    msr |= IA32_FEATURE_CONTROL_LOCK_MASK;
    __write_msr (IA32_FEATURE_CONTROL, msr);
  }

  return 0;
}

// clang-format off
#define IA32_VMX_EPTVPIDCAP_execute_only_pages_MASK                        (1ull <<  0)
#define IA32_VMX_EPTVPIDCAP_page_walk_length4_MASK                         (1ull <<  6)
#define IA32_VMX_EPTVPIDCAP_uncacheble_memory_type_MASK                    (1ull <<  8)
#define IA32_VMX_EPTVPIDCAP_write_back_memory_type_MASK                    (1ull << 14)
#define IA32_VMX_EPTVPIDCAP_pde_2mb_pages_MASK                             (1ull << 16)
#define IA32_VMX_EPTVPIDCAP_pdpte_1_gb_pages_MASK                          (1ull << 17)
#define IA32_VMX_EPTVPIDCAP_invept_MASK                                    (1ull << 20)
#define IA32_VMX_EPTVPIDCAP_accessed_and_dirty_flag_MASK                   (1ull << 21)
#define IA32_VMX_EPTVPIDCAP_single_context_invept_MASK                     (1ull << 25)
#define IA32_VMX_EPTVPIDCAP_all_context_invept_MASK                        (1ull << 26)
#define IA32_VMX_EPTVPIDCAP_invvpid_MASK                                   (1ull << 32)
#define IA32_VMX_EPTVPIDCAP_individual_address_invvpid_MASK                (1ull << 40)
#define IA32_VMX_EPTVPIDCAP_single_context_invvpid_MASK                    (1ull << 41)
#define IA32_VMX_EPTVPIDCAP_all_context_invvpid_MASK                       (1ull << 42)
#define IA32_VMX_EPTVPIDCAP_single_context_retaining_globals_invvpid_MASK  (1ull << 43)
// clang-format on

int check_ept ()
{
  vos_uint64 result = 0;
  vos_uint64 msr    = __read_msr (IA32_VMX_EPTVPIDCAP);
  result |= ((msr & IA32_VMX_EPTVPIDCAP_page_walk_length4_MASK) == 0);
  result |= ((msr & IA32_VMX_EPTVPIDCAP_write_back_memory_type_MASK) == 0);
  result |= ((msr & IA32_VMX_EPTVPIDCAP_invept_MASK) == 0);
  result |= ((msr & IA32_VMX_EPTVPIDCAP_single_context_invept_MASK) == 0);
  result |= ((msr & IA32_VMX_EPTVPIDCAP_all_context_invept_MASK) == 0);
  result |= ((msr & IA32_VMX_EPTVPIDCAP_invvpid_MASK) == 0);
  result |= ((msr & IA32_VMX_EPTVPIDCAP_individual_address_invvpid_MASK) == 0);
  result |= ((msr & IA32_VMX_EPTVPIDCAP_single_context_invvpid_MASK) == 0);
  result |= ((msr & IA32_VMX_EPTVPIDCAP_all_context_invvpid_MASK) == 0);
  result |= ((msr & IA32_VMX_EPTVPIDCAP_single_context_retaining_globals_invvpid_MASK) == 0);

  return result;
}

static void GuestEntry ()
{
  char vendor[13] = {0};
  puts ("GuestEntry begin");

  bochs_break ();
  *((vos_uint*)0) = 0x123456789abcdef0;

  cpuid_t cpuid;
  __cpuid (&cpuid, 0);

  ((vos_uint32*)vendor)[0] = cpuid.ebx;
  ((vos_uint32*)vendor)[1] = cpuid.edx;
  ((vos_uint32*)vendor)[2] = cpuid.ecx;
  print ("CPU Vendor : %s\n", vendor);

  __vos_vmx_vmcall (CMD_CHECK, 0, 0);
  __vos_vmx_vmcall (CMD_HOOK_FUNC, 0x1000, 0x2000);

  puts ("GuestEntry end");

  while (1)
    ;
}

vos_uint vos_vmx_vmexit_handler (VmxVMExitContext_t* context)
{
  vos_uint64 reason          = __vos_vmx_vmread (VMX_VMCS32_RO_EXIT_REASON);
  vos_uint64 instruction_len = __vos_vmx_vmread (VMX_VMCS32_RO_EXIT_INSTR_LENGTH);
  vos_uint64 basic_reason    = VMX_EXIT_REASON_BASIC (reason);

  switch (basic_reason)
  {
    case VMX_EXIT_INVALID:
      print ("VMX_EXIT_INVALID(%d)\n", VMX_EXIT_INVALID);
      goto succ;
    case VMX_EXIT_XCPT_OR_NMI:
      print ("VMX_EXIT_XCPT_OR_NMI(%d)\n", VMX_EXIT_XCPT_OR_NMI);
      goto succ;
    case VMX_EXIT_EXT_INT:
      print ("VMX_EXIT_EXT_INT(%d)\n", VMX_EXIT_EXT_INT);
      goto succ;
    case VMX_EXIT_TRIPLE_FAULT:
      print ("VMX_EXIT_TRIPLE_FAULT(%d)\n", VMX_EXIT_TRIPLE_FAULT);
      goto succ;
    case VMX_EXIT_INIT_SIGNAL:
      print ("VMX_EXIT_INIT_SIGNAL(%d)\n", VMX_EXIT_INIT_SIGNAL);
      goto succ;
    case VMX_EXIT_SIPI:
      print ("VMX_EXIT_SIPI(%d)\n", VMX_EXIT_SIPI);
      goto succ;
    case VMX_EXIT_IO_SMI:
      print ("VMX_EXIT_IO_SMI(%d)\n", VMX_EXIT_IO_SMI);
      goto succ;
    case VMX_EXIT_SMI:
      print ("VMX_EXIT_SMI(%d)\n", VMX_EXIT_SMI);
      goto succ;
    case VMX_EXIT_INT_WINDOW:
      print ("VMX_EXIT_INT_WINDOW(%d)\n", VMX_EXIT_INT_WINDOW);
      goto succ;
    case VMX_EXIT_NMI_WINDOW:
      print ("VMX_EXIT_NMI_WINDOW(%d)\n", VMX_EXIT_NMI_WINDOW);
      goto succ;
    case VMX_EXIT_TASK_SWITCH:
      print ("VMX_EXIT_TASK_SWITCH(%d)\n", VMX_EXIT_TASK_SWITCH);
      goto succ;
    case VMX_EXIT_CPUID:
      // print("VMX_EXIT_CPUID(%d)\n",                    VMX_EXIT_CPUID);
      if (context->rax == 0)
      {
        context->rax = 0;
        context->rbx = 'uneG';
        context->rdx = '0eni';
        context->rcx = 'cc7x';
      }
      else
      {
        cpuid_t cpuid;
        __cpuid (&cpuid, context->rax);
        context->rax = cpuid.eax;
        context->rbx = cpuid.ebx;
        context->rcx = cpuid.ecx;
        context->rdx = cpuid.edx;
      }
      return 0;
    case VMX_EXIT_GETSEC:
      print ("VMX_EXIT_GETSEC(%d)\n", VMX_EXIT_GETSEC);
      goto succ;
    case VMX_EXIT_HLT:
      print ("VMX_EXIT_HLT(%d)\n", VMX_EXIT_HLT);
      goto succ;
    case VMX_EXIT_INVD:
      print ("VMX_EXIT_INVD(%d)\n", VMX_EXIT_INVD);
      goto succ;
    case VMX_EXIT_INVLPG:
      print ("VMX_EXIT_INVLPG(%d)\n", VMX_EXIT_INVLPG);
      goto succ;
    case VMX_EXIT_RDPMC:
      print ("VMX_EXIT_RDPMC(%d)\n", VMX_EXIT_RDPMC);
      goto succ;
    case VMX_EXIT_RDTSC:
      print ("VMX_EXIT_RDTSC(%d)\n", VMX_EXIT_RDTSC);
      goto succ;
    case VMX_EXIT_RSM:
      print ("VMX_EXIT_RSM(%d)\n", VMX_EXIT_RSM);
      goto succ;
    case VMX_EXIT_VMCALL:
      //print ("VMX_EXIT_VMCALL(%d)\n", VMX_EXIT_VMCALL);
      switch (context->argv0)
      {
        case CMD_CHECK:
          goto succ;
        case CMD_PUTS:
        {
          ept_PML4E_t* pml4 = (ept_PML4E_t*)(__vos_vmx_vmread (VMX_VMCS64_CTRL_EPTP_FULL) & ~0xfffull);
          const char*  str  = (char*)ept_translation (pml4, context->argv1);
          puts (str);
          context->rax = 0;
          goto succ;
        }
        // hook(void* gpa, void* hpa);
        case CMD_HOOK_FUNC:
        {
          ept_PML4E_t* pml4;
          pml4          = (ept_PML4E_t*)(__vos_vmx_vmread (VMX_VMCS64_CTRL_EPTP_FULL) & ~0xfffull);
          vos_uint vpid = __vos_vmx_vmread (VMX_VMCS16_VPID);

          print ("CMD_HOOK_FUNC from : 0x%x to 0x%x\n", context->argv1, context->argv2);

          register vos_uintptr src = context->argv1;
          register vos_uintptr dst = context->argv2;
          if (pa_to_pfn (src) == pa_to_pfn (dst))
            goto fail; // 同一个页.

          // hook page
          {
            ept_PTE_t* pt = ept_pt_get (pml4, src);
            if (pt->bits == 0)
              goto fail;

            pt->execute_access = 0;

            vos_uint8 *srcpageHPA, *execpageGPA, *execpageHPA;
            srcpageHPA  = (vos_uint8*)ept_translation (pml4, src & ~0xfffull);
            execpageGPA = (vos_uint8*)guest_malloc ((vos_guest_t*)guests[vpid], VOS_PAGE_SIZE);
            execpageHPA = (vos_uint8*)ept_translation (pml4, (vos_uint)execpageGPA);
            // ept_PTE_t* execpagePT      = ept_pt_get (pml4, execpageGPA);
            // execpagePT->execute_access = 1;

            memcpy (execpageHPA, srcpageHPA, VOS_PAGE_SIZE);
            register vos_uint offset               = src & 0xfffull;
            execpageHPA[offset + 0]                = 0x48;
            execpageHPA[offset + 1]                = 0xb8;
            *(vos_uint*)(&execpageHPA[offset + 2]) = dst;
            execpageHPA[offset + 10]               = 0xff;
            execpageHPA[offset + 11]               = 0xe0;

            // 如果guest的下一条指令正好在被hook的页中,现在立刻就要跳到执行页中.
            if (pa_to_pfn (context->rip) == pa_to_pfn (src))
            {
              bochs_break ();
              register vos_uint offset_ = (context->rip + instruction_len) & 0xfffull;
              context->rip              = (vos_uint64) (execpageGPA + offset_);
              goto jump;
            }
          }
        }
        case CMD_HIDE_PROCESS:
          puts ("CMD_HIDE_PROCESS");
          context->rax = context->argv0;
          goto succ;
        case CMD_PROTECT_PROCESS:
          puts ("CMD_PROTECT_PROCESS");
          context->rax = context->argv0;
          goto succ;
        default:
          print ("VMX_EXIT_VMCALL(%d) not handle, argv0 : \n", VMX_EXIT_VMCALL, context->argv0);
          goto fail;
      }
      goto succ;
    case VMX_EXIT_VMCLEAR:
      print ("VMX_EXIT_VMCLEAR(%d)\n", VMX_EXIT_VMCLEAR);
      goto succ;
    case VMX_EXIT_VMLAUNCH:
      print ("VMX_EXIT_VMLAUNCH(%d)\n", VMX_EXIT_VMLAUNCH);
      goto succ;
    case VMX_EXIT_VMPTRLD:
      print ("VMX_EXIT_VMPTRLD(%d)\n", VMX_EXIT_VMPTRLD);
      goto succ;
    case VMX_EXIT_VMPTRST:
      print ("VMX_EXIT_VMPTRST(%d)\n", VMX_EXIT_VMPTRST);
      goto succ;
    case VMX_EXIT_VMREAD:
      print ("VMX_EXIT_VMREAD(%d)\n", VMX_EXIT_VMREAD);
      goto succ;
    case VMX_EXIT_VMRESUME:
      print ("VMX_EXIT_VMRESUME(%d)\n", VMX_EXIT_VMRESUME);
      goto succ;
    case VMX_EXIT_VMWRITE:
      print ("VMX_EXIT_VMWRITE(%d)\n", VMX_EXIT_VMWRITE);
      goto succ;
    case VMX_EXIT_VMXOFF:
      print ("VMX_EXIT_VMXOFF(%d)\n", VMX_EXIT_VMXOFF);
      goto succ;
    case VMX_EXIT_VMXON:
      print ("VMX_EXIT_VMXON(%d)\n", VMX_EXIT_VMXON);
      goto succ;
    case VMX_EXIT_MOV_CRX:
      print ("VMX_EXIT_MOV_CRX(%d)\n", VMX_EXIT_MOV_CRX);
      goto succ;
    case VMX_EXIT_MOV_DRX:
      print ("VMX_EXIT_MOV_DRX(%d)\n", VMX_EXIT_MOV_DRX);
      goto succ;
    case VMX_EXIT_IO_INSTR:
      print ("VMX_EXIT_IO_INSTR(%d)\n", VMX_EXIT_IO_INSTR);
      goto succ;
    case VMX_EXIT_RDMSR:
      print ("VMX_EXIT_RDMSR(%d)\n", VMX_EXIT_RDMSR);
      goto succ;
    case VMX_EXIT_WRMSR:
      print ("VMX_EXIT_WRMSR(%d)\n", VMX_EXIT_WRMSR);
      goto succ;
    case VMX_EXIT_ERR_INVALID_GUEST_STATE:
      print ("VMX_EXIT_ERR_INVALID_GUEST_STATE(%d)\n", VMX_EXIT_ERR_INVALID_GUEST_STATE);
      print ("rax : 0x%x, rbx : 0x%x, rcx : 0x%x, rdx : 0x%x\n", context->rax, context->rbx, context->rcx, context->rdx);
      print ("rsi : 0x%x, rdi : 0x%x, rsp : 0x%x, rip : 0x%x\n", context->rsi, context->rdi, __vos_vmx_vmread (VMX_VMCS_GUEST_RSP), __vos_vmx_vmread (VMX_VMCS_GUEST_RIP));
      print ("r8  : 0x%x, r9  : 0x%x, r10 : 0x%x, r11 : 0x%x\n", context->r8, context->r9, context->r10, context->r11);
      print ("r12 : 0x%x, r13 : 0x%x, r14 : 0x%x, r15 : 0x%x\n", context->r12, context->r13, context->r14, context->r15);
      print ("VMX_VMCS32_CTRL_PIN_EXEC : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_PIN_EXEC));
      print ("VMX_VMCS32_CTRL_PROC_EXEC : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_PROC_EXEC));
      print ("VMX_VMCS32_CTRL_EXCEPTION_BITMAP : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_EXCEPTION_BITMAP));
      print ("VMX_VMCS32_CTRL_PAGEFAULT_ERROR_MASK : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_PAGEFAULT_ERROR_MASK));
      print ("VMX_VMCS32_CTRL_PAGEFAULT_ERROR_MATCH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_PAGEFAULT_ERROR_MATCH));
      print ("VMX_VMCS32_CTRL_CR3_TARGET_COUNT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_CR3_TARGET_COUNT));
      print ("VMX_VMCS32_CTRL_EXIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_EXIT));
      print ("VMX_VMCS32_CTRL_EXIT_MSR_STORE_COUNT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_EXIT_MSR_STORE_COUNT));
      print ("VMX_VMCS32_CTRL_EXIT_MSR_LOAD_COUNT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_EXIT_MSR_LOAD_COUNT));
      print ("VMX_VMCS32_CTRL_ENTRY : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_ENTRY));
      print ("VMX_VMCS32_CTRL_ENTRY_MSR_LOAD_COUNT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_ENTRY_MSR_LOAD_COUNT));
      print ("VMX_VMCS32_CTRL_ENTRY_INTERRUPTION_INFO : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_ENTRY_INTERRUPTION_INFO));
      print ("VMX_VMCS32_CTRL_ENTRY_EXCEPTION_ERRCODE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_ENTRY_EXCEPTION_ERRCODE));
      print ("VMX_VMCS32_CTRL_ENTRY_INSTR_LENGTH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_ENTRY_INSTR_LENGTH));
      print ("VMX_VMCS32_CTRL_TPR_THRESHOLD : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_TPR_THRESHOLD));
      print ("VMX_VMCS32_CTRL_PROC_EXEC2 : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_PROC_EXEC2));
      print ("VMX_VMCS32_CTRL_PLE_GAP : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_PLE_GAP));
      print ("VMX_VMCS32_CTRL_PLE_WINDOW : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_CTRL_PLE_WINDOW));
      print ("VMX_VMCS16_GUEST_ES_SEL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS16_GUEST_ES_SEL));
      print ("VMX_VMCS16_GUEST_CS_SEL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS16_GUEST_CS_SEL));
      print ("VMX_VMCS16_GUEST_SS_SEL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS16_GUEST_SS_SEL));
      print ("VMX_VMCS16_GUEST_DS_SEL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS16_GUEST_DS_SEL));
      print ("VMX_VMCS16_GUEST_FS_SEL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS16_GUEST_FS_SEL));
      print ("VMX_VMCS16_GUEST_GS_SEL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS16_GUEST_GS_SEL));
      print ("VMX_VMCS16_GUEST_LDTR_SEL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS16_GUEST_LDTR_SEL));
      print ("VMX_VMCS16_GUEST_TR_SEL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS16_GUEST_TR_SEL));
      print ("VMX_VMCS16_GUEST_INTR_STATUS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS16_GUEST_INTR_STATUS));
      print ("VMX_VMCS16_GUEST_PML_INDEX : 0x%x\n", __vos_vmx_vmread (VMX_VMCS16_GUEST_PML_INDEX));
      print ("VMX_VMCS64_RO_GUEST_PHYS_ADDR_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_RO_GUEST_PHYS_ADDR_FULL));
      print ("VMX_VMCS64_RO_GUEST_PHYS_ADDR_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_RO_GUEST_PHYS_ADDR_HIGH));
      print ("VMX_VMCS64_GUEST_VMCS_LINK_PTR_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_VMCS_LINK_PTR_FULL));
      print ("VMX_VMCS64_GUEST_VMCS_LINK_PTR_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_VMCS_LINK_PTR_HIGH));
      print ("VMX_VMCS64_GUEST_DEBUGCTL_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_DEBUGCTL_FULL));
      print ("VMX_VMCS64_GUEST_DEBUGCTL_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_DEBUGCTL_HIGH));
      print ("VMX_VMCS64_GUEST_PAT_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PAT_FULL));
      print ("VMX_VMCS64_GUEST_PAT_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PAT_HIGH));
      print ("VMX_VMCS64_GUEST_EFER_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_EFER_FULL));
      print ("VMX_VMCS64_GUEST_EFER_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_EFER_HIGH));
      print ("VMX_VMCS64_GUEST_PERF_GLOBAL_CTRL_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PERF_GLOBAL_CTRL_FULL));
      print ("VMX_VMCS64_GUEST_PERF_GLOBAL_CTRL_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PERF_GLOBAL_CTRL_HIGH));
      print ("VMX_VMCS64_GUEST_PDPTE0_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PDPTE0_FULL));
      print ("VMX_VMCS64_GUEST_PDPTE0_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PDPTE0_HIGH));
      print ("VMX_VMCS64_GUEST_PDPTE1_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PDPTE1_FULL));
      print ("VMX_VMCS64_GUEST_PDPTE1_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PDPTE1_HIGH));
      print ("VMX_VMCS64_GUEST_PDPTE2_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PDPTE2_FULL));
      print ("VMX_VMCS64_GUEST_PDPTE2_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PDPTE2_HIGH));
      print ("VMX_VMCS64_GUEST_PDPTE3_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PDPTE3_FULL));
      print ("VMX_VMCS64_GUEST_PDPTE3_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_PDPTE3_HIGH));
      print ("VMX_VMCS64_GUEST_BNDCFGS_FULL : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_BNDCFGS_FULL));
      print ("VMX_VMCS64_GUEST_BNDCFGS_HIGH : 0x%x\n", __vos_vmx_vmread (VMX_VMCS64_GUEST_BNDCFGS_HIGH));
      print ("VMX_VMCS32_GUEST_ES_LIMIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_ES_LIMIT));
      print ("VMX_VMCS32_GUEST_CS_LIMIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_CS_LIMIT));
      print ("VMX_VMCS32_GUEST_SS_LIMIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_SS_LIMIT));
      print ("VMX_VMCS32_GUEST_DS_LIMIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_DS_LIMIT));
      print ("VMX_VMCS32_GUEST_FS_LIMIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_FS_LIMIT));
      print ("VMX_VMCS32_GUEST_GS_LIMIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_GS_LIMIT));
      print ("VMX_VMCS32_GUEST_LDTR_LIMIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_LDTR_LIMIT));
      print ("VMX_VMCS32_GUEST_TR_LIMIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_TR_LIMIT));
      print ("VMX_VMCS32_GUEST_GDTR_LIMIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_GDTR_LIMIT));
      print ("VMX_VMCS32_GUEST_IDTR_LIMIT : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_IDTR_LIMIT));
      print ("VMX_VMCS32_GUEST_ES_ACCESS_RIGHTS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_ES_ACCESS_RIGHTS));
      print ("VMX_VMCS32_GUEST_CS_ACCESS_RIGHTS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_CS_ACCESS_RIGHTS));
      print ("VMX_VMCS32_GUEST_SS_ACCESS_RIGHTS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_SS_ACCESS_RIGHTS));
      print ("VMX_VMCS32_GUEST_DS_ACCESS_RIGHTS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_DS_ACCESS_RIGHTS));
      print ("VMX_VMCS32_GUEST_FS_ACCESS_RIGHTS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_FS_ACCESS_RIGHTS));
      print ("VMX_VMCS32_GUEST_GS_ACCESS_RIGHTS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_GS_ACCESS_RIGHTS));
      print ("VMX_VMCS32_GUEST_LDTR_ACCESS_RIGHTS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_LDTR_ACCESS_RIGHTS));
      print ("VMX_VMCS32_GUEST_TR_ACCESS_RIGHTS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_TR_ACCESS_RIGHTS));
      print ("VMX_VMCS32_GUEST_INT_STATE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_INT_STATE));
      print ("VMX_VMCS32_GUEST_ACTIVITY_STATE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_ACTIVITY_STATE));
      print ("VMX_VMCS32_GUEST_SMBASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_SMBASE));
      print ("VMX_VMCS32_GUEST_SYSENTER_CS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS32_GUEST_SYSENTER_CS));
      print ("VMX_VMCS_RO_GUEST_LINEAR_ADDR : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_RO_GUEST_LINEAR_ADDR));
      print ("VMX_VMCS_GUEST_CR0 : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_CR0));
      print ("VMX_VMCS_GUEST_CR3 : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_CR3));
      print ("VMX_VMCS_GUEST_CR4 : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_CR4));
      print ("VMX_VMCS_GUEST_ES_BASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_ES_BASE));
      print ("VMX_VMCS_GUEST_CS_BASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_CS_BASE));
      print ("VMX_VMCS_GUEST_SS_BASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_SS_BASE));
      print ("VMX_VMCS_GUEST_DS_BASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_DS_BASE));
      print ("VMX_VMCS_GUEST_FS_BASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_FS_BASE));
      print ("VMX_VMCS_GUEST_GS_BASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_GS_BASE));
      print ("VMX_VMCS_GUEST_LDTR_BASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_LDTR_BASE));
      print ("VMX_VMCS_GUEST_TR_BASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_TR_BASE));
      print ("VMX_VMCS_GUEST_GDTR_BASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_GDTR_BASE));
      print ("VMX_VMCS_GUEST_IDTR_BASE : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_IDTR_BASE));
      print ("VMX_VMCS_GUEST_DR7 : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_DR7));
      print ("VMX_VMCS_GUEST_RSP : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_RSP));
      print ("VMX_VMCS_GUEST_RIP : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_RIP));
      print ("VMX_VMCS_GUEST_RFLAGS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_RFLAGS));
      print ("VMX_VMCS_GUEST_PENDING_DEBUG_XCPTS : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_PENDING_DEBUG_XCPTS));
      print ("VMX_VMCS_GUEST_SYSENTER_ESP : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_SYSENTER_ESP));
      print ("VMX_VMCS_GUEST_SYSENTER_EIP : 0x%x\n", __vos_vmx_vmread (VMX_VMCS_GUEST_SYSENTER_EIP));
      goto fatal;
    case VMX_EXIT_ERR_MSR_LOAD:
      print ("VMX_EXIT_ERR_MSR_LOAD(%d)\n", VMX_EXIT_ERR_MSR_LOAD);
      goto succ;
    case VMX_EXIT_MWAIT:
      print ("VMX_EXIT_MWAIT(%d)\n", VMX_EXIT_MWAIT);
      goto succ;
    case VMX_EXIT_MTF:
      print ("VMX_EXIT_MTF(%d), RIP : 0x%x\n", VMX_EXIT_MTF, __vos_vmx_vmread (VMX_VMCS_GUEST_RIP));
      goto succ;
    case VMX_EXIT_MONITOR:
      print ("VMX_EXIT_MONITOR(%d)\n", VMX_EXIT_MONITOR);
      goto succ;
    case VMX_EXIT_PAUSE:
      print ("VMX_EXIT_PAUSE(%d)\n", VMX_EXIT_PAUSE);
      goto succ;
    case VMX_EXIT_ERR_MACHINE_CHECK:
      print ("VMX_EXIT_ERR_MACHINE_CHECK(%d)\n", VMX_EXIT_ERR_MACHINE_CHECK);
      goto succ;
    case VMX_EXIT_TPR_BELOW_THRESHOLD:
      print ("VMX_EXIT_TPR_BELOW_THRESHOLD(%d)\n", VMX_EXIT_TPR_BELOW_THRESHOLD);
      goto succ;
    case VMX_EXIT_APIC_ACCESS:
      print ("VMX_EXIT_APIC_ACCESS(%d)\n", VMX_EXIT_APIC_ACCESS);
      goto succ;
    case VMX_EXIT_VIRTUALIZED_EOI:
      print ("VMX_EXIT_VIRTUALIZED_EOI(%d)\n", VMX_EXIT_VIRTUALIZED_EOI);
      goto succ;
    case VMX_EXIT_GDTR_IDTR_ACCESS:
      print ("VMX_EXIT_GDTR_IDTR_ACCESS(%d)\n", VMX_EXIT_GDTR_IDTR_ACCESS);
      goto succ;
    case VMX_EXIT_LDTR_TR_ACCESS:
      print ("VMX_EXIT_LDTR_TR_ACCESS(%d)\n", VMX_EXIT_LDTR_TR_ACCESS);
      goto succ;
    case VMX_EXIT_EPT_VIOLATION:
      print ("VMX_EXIT_EPT_VIOLATION(%d)\n", VMX_EXIT_EPT_VIOLATION);
      goto succ;
    case VMX_EXIT_EPT_MISCONFIG:
      print ("VMX_EXIT_EPT_MISCONFIG(%d)\n", VMX_EXIT_EPT_MISCONFIG);
      goto succ;
    case VMX_EXIT_INVEPT:
      print ("VMX_EXIT_INVEPT(%d)\n", VMX_EXIT_INVEPT);
      goto succ;
    case VMX_EXIT_RDTSCP:
      print ("VMX_EXIT_RDTSCP(%d)\n", VMX_EXIT_RDTSCP);
      goto succ;
    case VMX_EXIT_PREEMPT_TIMER:
      print ("VMX_EXIT_PREEMPT_TIMER(%d)\n", VMX_EXIT_PREEMPT_TIMER);
      goto succ;
    case VMX_EXIT_INVVPID:
      print ("VMX_EXIT_INVVPID(%d)\n", VMX_EXIT_INVVPID);
      goto succ;
    case VMX_EXIT_WBINVD:
      print ("VMX_EXIT_WBINVD(%d)\n", VMX_EXIT_WBINVD);
      goto succ;
    case VMX_EXIT_XSETBV:
      print ("VMX_EXIT_XSETBV(%d)\n", VMX_EXIT_XSETBV);
      goto succ;
    case VMX_EXIT_APIC_WRITE:
      print ("VMX_EXIT_APIC_WRITE(%d)\n", VMX_EXIT_APIC_WRITE);
      goto succ;
    case VMX_EXIT_RDRAND:
      print ("VMX_EXIT_RDRAND(%d)\n", VMX_EXIT_RDRAND);
      goto succ;
    case VMX_EXIT_INVPCID:
      print ("VMX_EXIT_INVPCID(%d)\n", VMX_EXIT_INVPCID);
      goto succ;
    case VMX_EXIT_VMFUNC:
      print ("VMX_EXIT_VMFUNC(%d)\n", VMX_EXIT_VMFUNC);
      goto succ;
    case VMX_EXIT_ENCLS:
      print ("VMX_EXIT_ENCLS(%d)\n", VMX_EXIT_ENCLS);
      goto succ;
    case VMX_EXIT_RDSEED:
      print ("VMX_EXIT_RDSEED(%d)\n", VMX_EXIT_RDSEED);
      goto succ;
    case VMX_EXIT_PML_FULL:
      print ("VMX_EXIT_PML_FULL(%d)\n", VMX_EXIT_PML_FULL);
      goto succ;
    case VMX_EXIT_XSAVES:
      print ("VMX_EXIT_XSAVES(%d)\n", VMX_EXIT_XSAVES);
      goto succ;
    case VMX_EXIT_XRSTORS:
      print ("VMX_EXIT_XRSTORS(%d)\n", VMX_EXIT_XRSTORS);
      goto succ;
    case VMX_EXIT_SPP_EVENT:
      print ("VMX_EXIT_SPP_EVENT(%d)\n", VMX_EXIT_SPP_EVENT);
      goto succ;
    case VMX_EXIT_UMWAIT:
      print ("VMX_EXIT_UMWAIT(%d)\n", VMX_EXIT_UMWAIT);
      goto succ;
    case VMX_EXIT_TPAUSE:
      print ("VMX_EXIT_TPAUSE(%d)\n", VMX_EXIT_TPAUSE);
      goto succ;
    default:
      goto fatal;
  }
fail:
  context->rax = -1;
succ:
  context->rip += instruction_len;
jump:
  return 0;

fatal:
  return -1;
}

static vos_uint AdjustMSR (vos_uint msr, vos_uint bits)
{
  vos_uint64 v = __read_msr (msr);
  // bit == 0 in high word ==> must be zero
  bits &= (v >> 32);
  // bit == 1 in low word  ==> must be one
  bits |= (v & 0xffffffff);

  return bits;
}

#define CPUID_0x80000008_EAX_PA_BITS(EAX) (EAX & 0xff)        // 物理地址位宽.
#define CPUID_0x80000008_EAX_LA_BITS(EAX) ((EAX >> 8) & 0xff) // 线性地址位宽.

int vmx_start (vos_vmx_guest_t* guest)
{
  cpuid_t cpuid;
  __cpuid (&cpuid, 0x80000008);
  vos_uint8 pa_width = CPUID_0x80000008_EAX_PA_BITS (cpuid.eax);
  vos_uint8 la_width = CPUID_0x80000008_EAX_LA_BITS (cpuid.eax);

  __memset16 (guests, 0, sizeof (guests));

  vos_uint64 msr = __read_msr (IA32_VMX_BASIC);

  vos_uint64 vmcs_size        = IA32_VMX_BASIC_VMCS_SIZE (msr);
  vos_uint64 vmcs_revision_id = (msr & IA32_VMX_BASIC_VMCS_REVISION_IDENTIFIER_MASK);

  guest->host_vmcs = (void*)calloc (4096);

  *((vos_uint64*)guest->host_vmcs) = vmcs_revision_id;

  print ("VMCS revision id : 0x%x\n", vmcs_revision_id);

  vos_uint64 hostPA = HVA_to_HPA ((vos_uint64)guest->host_vmcs);
  __vos_vmx_vmon ((vos_uint64)&hostPA);

  vos_uint64 rflags = __rflags ();
  if ((rflags & FLAGS_CF_MASK) != 0)
  {
    puts ("vmxon failed.");
    return -1;
  }

  puts ("vmxon successful.");

  guest->guest_vmcs                 = calloc (vmcs_size);
  *((vos_uint64*)guest->guest_vmcs) = vmcs_revision_id;

  vos_uint64 vmcsPA = HVA_to_HPA ((vos_uint64)guest->guest_vmcs);
  __vos_vmx_vmclear ((vos_uint64)&vmcsPA);

  __vos_vmx_vmptrld ((vos_uint64)&vmcsPA);

  gdtr_t gdtr;
  idtr_t idtr;
  __read_gdtr (&gdtr);
  __read_idtr (&idtr);

  ept_PML4E_t *ept_PA, *ept_VA;
  ept_VA               = (ept_PML4E_t*)ept_init (guest->_.num_mem_pages);
  ept_PA               = (ept_PML4E_t*)HVA_to_HPA ((vos_uintptr)ept_VA);
  guest->ept_base_HVA  = (vos_uintptr)ept_VA;
  EptPointer ptr       = {0};
  ptr.memory_type      = 6;
  ptr.page_walk_length = 4 - 1; // 4级页表
  ptr.pml4_address     = pa_to_pfn ((vos_uint)ept_PA);

  vos_uint vmret = 0;
  // See: Definitions of Pin-Based VM-Execution Controls
  vmret |= __vos_vmx_vmwrite (VMX_VMCS32_CTRL_PIN_EXEC, AdjustMSR (MSR_IA32_VMX_PINBASED_CTLS, 0));

  VmxPrimaryProcessorBasedControls   primary   = {.bits = 0};
  VmxSecondaryProcessorBasedControls secondary = {.bits = 0};

  primary.monitor_trap_flag          = guest->_.enable_debug;
  primary.activate_secondary_control = 1;

  secondary.enable_ept              = 1;
  secondary.enable_vpid             = 1;
  secondary.enable_rdtscp           = 1;
  secondary.enable_invpcid          = 1;
  secondary.enable_ept_violation_ve = 1;
  secondary.enable_xsaves_xstors    = 1;

  // See: Definitions of Primary Processor-Based VM-Execution Controls
  vmret |= __vos_vmx_vmwrite (VMX_VMCS32_CTRL_PROC_EXEC, AdjustMSR (MSR_IA32_VMX_PROCBASED_CTLS, primary.bits));

  // See: Definitions of Secondary Processor-Based VM-Execution Controls
  vmret |= __vos_vmx_vmwrite (VMX_VMCS32_CTRL_PROC_EXEC2, AdjustMSR (MSR_IA32_VMX_PROCBASED_CTLS2, secondary.bits));
  vmret |= __vos_vmx_vmwrite (VMX_VMCS32_CTRL_EXIT, AdjustMSR (MSR_IA32_VMX_EXIT_CTLS, VMX_EXIT_CTLS_HOST_ADDR_SPACE_SIZE));
  vmret |= __vos_vmx_vmwrite (VMX_VMCS32_CTRL_ENTRY, AdjustMSR (MSR_IA32_VMX_ENTRY_CTLS, 0));
  vmret |= __vos_vmx_vmwrite (VMX_VMCS64_CTRL_EPTP_FULL, ptr.bits);
  vmret |= __vos_vmx_vmwrite (VMX_VMCS64_GUEST_PDPTE0_FULL, pa_to_pfn (ept_PA[0].pdpt_page_PA));
  vmret |= __vos_vmx_vmwrite (VMX_VMCS64_GUEST_PDPTE1_FULL, pa_to_pfn (ept_PA[1].pdpt_page_PA));
  vmret |= __vos_vmx_vmwrite (VMX_VMCS64_GUEST_PDPTE2_FULL, pa_to_pfn (ept_PA[2].pdpt_page_PA));
  vmret |= __vos_vmx_vmwrite (VMX_VMCS64_GUEST_PDPTE3_FULL, pa_to_pfn (ept_PA[3].pdpt_page_PA));
  vmret |= __vos_vmx_vmwrite (VMX_VMCS16_VPID, 1);
  guests[1] = guest;

  // Host
  {
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_HOST_ES_SEL, __read_es () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_HOST_CS_SEL, __read_cs () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_HOST_SS_SEL, __read_ss () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_HOST_DS_SEL, __read_ds () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_HOST_FS_SEL, __read_fs () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_HOST_GS_SEL, __read_gs () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_HOST_TR_SEL, 8 & 0xfff8);

    vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_TR_BASE, 8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_GDTR_BASE, gdtr.base); // 居然没有设置limit的接口...
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_IDTR_BASE, idtr.base); // 居然没有设置limit的接口...

    //  vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_IA32_SYSENTER_CS_MSR, __read_msr(MSR_IA32_SYSENTER_CS));
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_SYSENTER_ESP, __read_msr (MSR_IA32_SYSENTER_ESP));
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_SYSENTER_EIP, __read_msr (MSR_IA32_SYSENTER_EIP));

    vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_CR0, __read_cr0 ());
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_CR3, __read_cr3 ());
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_CR4, __read_cr4 ());

    vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_RSP, 4096 + (vos_uint64)calloc (4096)); // 返回Host时的栈底指针.栈是向下增长,所以把指针指向内存末尾.
    // vmret |= __vos_vmx_vmwrite (VMX_VMCS_HOST_RIP, (vos_uint64)&__vos_vmx_vmexit_handler);
  }

  // Guest, See: 24.4 GUEST-STATE AREA
  {
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_RFLAGS, __rflags ());
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_CR0, __read_cr0 ());

    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_CR3, (vos_uint64)make_vmx_PML4E (guest, guest->_.num_mem_pages));
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_CR4, __read_cr4 ());
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_DR7, 0x400);

    vmret |= __vos_vmx_vmwrite (VMX_VMCS64_GUEST_VMCS_LINK_PTR_FULL, 0xffffffff);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS64_GUEST_VMCS_LINK_PTR_HIGH, 0xffffffff);

    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_CTRL_ENTRY, AdjustMSR (IA32_VMX_ENTRYCTLS, 0b1000000000)); // IA32e guest
    //    vmret |= __vos_vmx_vmwrite(VMX_VMCS32_CTRL_ENTRY, 0b00000000000000000000001000000000);
    //    vmret |= __vos_vmx_vmwrite(VMX_VMCS32_CTRL_ENTRY_MSR_LOAD_COUNT, 0b1000001000000000);

    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_GUEST_ES_SEL, __read_es () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_GUEST_CS_SEL, __read_cs () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_GUEST_SS_SEL, __read_ss () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_GUEST_DS_SEL, __read_ds () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_GUEST_FS_SEL, __read_fs () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_GUEST_GS_SEL, __read_gs () & 0xfff8);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS16_GUEST_TR_SEL, 8 & 0xfff8);

    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_ES_BASE, 0);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_CS_BASE, 0);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_SS_BASE, 0);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_DS_BASE, 0);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_FS_BASE, 0);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_GS_BASE, 0);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_TR_BASE, 0);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_LDTR_BASE, 0);
    // vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_GDTR_BASE, gdtr.base);
    // vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_GDTR_LIMIT, gdtr.limit);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_IDTR_BASE, idtr.base);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_IDTR_LIMIT, idtr.limit);
    make_vmx_gdt (guest);

    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_ES_LIMIT, 0xffffffff);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_CS_LIMIT, 0xffffffff);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_SS_LIMIT, 0xffffffff);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_DS_LIMIT, 0xffffffff);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_FS_LIMIT, 0xffffffff);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_GS_LIMIT, 0xffffffff);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_LDTR_LIMIT, 0xffffffff);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_TR_LIMIT, 0xffffffff);

    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_ES_ACCESS_RIGHTS, 0b1000000010010001);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_CS_ACCESS_RIGHTS, 0b1010000010011101);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_SS_ACCESS_RIGHTS, 0b1000000010010011);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_DS_ACCESS_RIGHTS, 0b1000000010010001);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_FS_ACCESS_RIGHTS, 0b1000000010010001);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_GS_ACCESS_RIGHTS, 0b1000000010010001);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_LDTR_ACCESS_RIGHTS, 0b1000000010000010);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS32_GUEST_TR_ACCESS_RIGHTS, 0b1000000010001011);

    vos_uint code_base = guest_malloc ((vos_guest_t*)guest, VOS_PAGE_SIZE * 4);
    // clang-format off
    {
      vos_uint8*    bin = (vos_uint8*)ept_translation ((ept_PML4E_t*)guest->ept_base_HVA, code_base);
      unsigned char test01[] = {
        0xe8, 0x44, 0x00, 0x00, 0x00, 0x48, 0x89, 0xc5, 0xbf, 0xdb, 0x14, 0xcd,
        0x14, 0xbe, 0x00, 0x10, 0x00, 0x00, 0xba, 0x00, 0x20, 0x00, 0x00, 0x0f,
        0x01, 0xc1, 0xe8, 0x33, 0x00, 0x00, 0x00, 0xbf, 0xdd, 0x14, 0xcd, 0x14,
        0x48, 0x89, 0xe8, 0x48, 0x05, 0x52, 0x00, 0x00, 0x00, 0x48, 0x89, 0xc6,
        0x48, 0x89, 0xe8, 0x48, 0x05, 0xa7, 0x10, 0x00, 0x00, 0x48, 0x89, 0xc2,
        0x0f, 0x01, 0xc1, 0x66, 0x87, 0xdb, 0xe8, 0x0b, 0x00, 0x00, 0x00, 0xeb,
        0xfe, 0x48, 0x8b, 0x04, 0x24, 0x48, 0x83, 0xe8, 0x05, 0xc3, 0xbf, 0xdc,
        0x14, 0xcd, 0x14, 0x48, 0x89, 0xe8, 0x48, 0x05, 0x67, 0x00, 0x00, 0x00,
        0x48, 0x89, 0xc6, 0x0f, 0x01, 0xc1, 0xc3, 0x68, 0x65, 0x6c, 0x6c, 0x6f,
        0x21, 0x20, 0x68, 0x65, 0x72, 0x65, 0x20, 0x69, 0x73, 0x20, 0x6f, 0x72,
        0x69, 0x67, 0x69, 0x6e, 0x61, 0x6c, 0x20, 0x66, 0x75, 0x6e, 0x63, 0x74,
        0x69, 0x6f, 0x6e, 0x2e, 0x00, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x21, 0x20,
        0x68, 0x65, 0x72, 0x65, 0x20, 0x69, 0x73, 0x20, 0x68, 0x6f, 0x6f, 0x6b,
        0x20, 0x66, 0x75, 0x6e, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x2e, 0x00, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc,
        0xcc, 0xcc, 0xcc, 0xbf, 0xdc, 0x14, 0xcd, 0x14, 0x48, 0x89, 0xe8, 0x48,
        0x05, 0x89, 0x00, 0x00, 0x00, 0x48, 0x89, 0xc6, 0x0f, 0x01, 0xc1, 0xc3
      };
      unsigned int test01_len = 4284;
      memcpy (bin, test01, test01_len);
    }
    // clang-format on

    //vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_RSP, 4096 + (uint64)calloc (4096)); // Guest 中的栈底指针.栈是向下增长,所以把指针指向内存末尾.
    //vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_RIP, (uint64)&GuestEntry);
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_RSP, VOS_PAGE_SIZE * guest->_.num_mem_pages); // Guest 中的栈底指针.栈是向下增长,所以把指针指向内存末尾.
    vmret |= __vos_vmx_vmwrite (VMX_VMCS_GUEST_RIP, code_base);
  }

  if (vmret != 0)
  {
    print ("vmwrite fail : 0x%x\n", vmret);
    return -1;
  }
  print ("vmcs : 0x%x\n", guest->guest_vmcs);

  __vos_vmx_vmlaunch ();

  vos_uint64 error_code = __vos_vmx_vmread (VMX_VMCS32_RO_VM_INSTR_ERROR);
  puts (VMX_INSTRUCTION_ERROR_STRING (error_code));

  return 0;
}

int vmx_stop ()
{
  __vos_vmx_vmoff ();

  vos_uint64 cr4 = __read_cr4 ();
  cr4 &= ~CR4_VMXE_MASK;
  __write_cr4 (cr4);

  return 0;
}

void intel_entry ()
{
  vos_vmx_guest_t guest;
  __memset8 (&guest, 0, sizeof (guest));
  guest._.enable_physical_address_translation = 1;
  //guest.mem_page_count     = 0x100000ull >> VOS_PAGE_SHIFT; // 1 MiB
  guest._.num_mem_pages = pa_to_pfn (0x10000ull); // 1 MiB

  if (check_vmx () != 0)
  {
    puts ("VMX check failed");
    return;
  }

  puts ("VMX check successful.");

  if (guest._.enable_physical_address_translation && check_ept () != 0)
  {
    puts ("EPT check failed");
    return;
  }
  puts ("EPT check successful.");

  vmx_start (&guest);
  vmx_stop ();
}
